<!DOCTYPE html>
<html>
<head>
    <title>OptionsPaye - Options Trading Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-primary); min-height: 100vh; transition: all 0.3s ease; }
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255,255,255,0.95);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: rgba(0,0,0,0.1);
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: rgba(30,30,30,0.95);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: rgba(255,255,255,0.1);
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .section {
            background: rgba(40,40,40,0.95) !important;
        }
        [data-theme="dark"] .stock-card {
            background: rgba(50,50,50,0.9) !important;
            border-color: rgba(255,255,255,0.1) !important;
        }
        [data-theme="dark"] .portfolio-table th {
            background: rgba(60,60,60,0.8) !important;
        }
        [data-theme="dark"] .portfolio-table tr:hover {
            background: rgba(70,70,70,0.5) !important;
        }
        .header { background: var(--bg-secondary); backdrop-filter: blur(20px); color: var(--text-primary); padding: 24px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 32px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; }
        .balance { font-size: 20px; font-weight: 600; color: #27ae60; background: rgba(39,174,96,0.1); padding: 8px 16px; border-radius: 25px; }
        .logout { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 10px 20px; text-decoration: none; border-radius: 25px; font-weight: 500; transition: all 0.3s ease; }
        .logout:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 30px; position: relative; z-index: 1; }
        .section { background: rgba(255,255,255,0.95); margin-bottom: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(10px); overflow: visible; position: relative; z-index: 2; }
        .section-header { padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; font-size: 18px; color: #2c3e50; }
        .tabs { display: flex; background: rgba(0,0,0,0.02); }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: #7f8c8d; transition: all 0.3s ease; }
        .tab:hover { background: rgba(0,0,0,0.05); }
        .tab.active { border-bottom-color: #3498db; background: white; color: #2c3e50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stocks-grid { padding: 30px; }
        .options-grid { display: block; }
        .stock-card { background: white; border: 1px solid rgba(0,0,0,0.05); border-radius: 12px; padding: 20px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .stock-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .stock-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .stock-symbol { font-weight: 700; font-size: 18px; color: #2c3e50; }
        .stock-price { font-size: 22px; font-weight: 700; }
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .stock-actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn-buy { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
        .btn-buy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39,174,96,0.4); }
        .btn-sell { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .btn-sell:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
        .portfolio-table { width: 100%; border-collapse: collapse; }
        .portfolio-table th, .portfolio-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .portfolio-table th { background: rgba(0,0,0,0.02); font-weight: 600; color: #2c3e50; }
        .portfolio-table tr:hover { background: rgba(0,0,0,0.02); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; width: 400px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; cursor: move; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; cursor: move; user-select: none; }
        .modal-content.dragging { cursor: grabbing; }
        .modal-header h3 { color: #2c3e50; font-weight: 600; }
        .close { cursor: pointer; font-size: 28px; color: #95a5a6; transition: color 0.3s ease; }
        .close:hover { color: #e74c3c; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #3498db; }
        .greeks-row { font-size: 12px; color: #7f8c8d; margin-bottom: 12px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .greek-item { background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px; text-align: center; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .video-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; }
        .video-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .video-thumbnail { width: 100%; height: 180px; background-size: cover; background-position: center; position: relative; }
        .play-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,0,0,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        .video-info { padding: 20px; }
        .video-title { font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 16px; line-height: 1.4; }
        .video-channel { color: #7f8c8d; font-size: 14px; margin-bottom: 5px; }
        .video-duration { color: #95a5a6; font-size: 12px; }
        .theme-switch input:checked + .slider { background-color: #3498db; }
        .theme-switch input:checked + .slider .slider-dot { transform: translateX(30px); }
    </style>
</head>
<body>
    <div class="header">
        <h1>OptionsPaye</h1>
        <div style="display: flex; align-items: center; gap: 20px;">
            <button onclick="toggleChatBot()" class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 10px 18px; border-radius: 25px; font-size: 14px; border: none; font-weight: 500;">ü§ñ AI Assistant</button>
            <div style="display: flex; align-items: center; gap: 15px; background: var(--bg-secondary); padding: 12px 20px; border-radius: 30px; border: 1px solid var(--border-color);">
                <span class="balance" style="font-weight: 600; color: var(--text-primary);">Balance: ‚Çπ<span id="balance">0</span></span>
                <button onclick="openAddFunds()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 8px 16px; border: none; border-radius: 20px; font-size: 13px; font-weight: 500;">+ Add Funds</button>
            </div>
            <div class="user-profile" onclick="openUserProfile()" style="position: relative;">
                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; cursor: pointer; border: 3px solid var(--border-color);">
                    <span id="userInitial">U</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>F&O Positions</span>
                <button class="btn btn-sell" onclick="exitAllPositions()" style="padding: 8px 16px; font-size: 14px;">Exit All Positions</button>
            </div>
            <div style="padding: 20px;">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Strike</th>
                            <th>Type</th>
                            <th>Lots</th>
                            <th>Avg Price</th>
                            <th>Current Price</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="foPortfolioBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <div class="section-header">Market Watch</div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('options')">Options Chain</div>
                <div class="tab" onclick="switchTab('futures')">Futures</div>
                <div class="tab" onclick="switchTab('index')">Index</div>
                <div class="tab" onclick="switchTab('strategies')">Strategies</div>
                <div class="tab" onclick="switchTab('learn')">Learn</div>
                <div class="tab" onclick="switchTab('profile')">Profile</div>
            </div>
            <div id="options" class="tab-content active">
                <div style="padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #2c3e50; margin: 0;">NIFTY 50 Options Chain</h3>
                            <p style="color: #27ae60; margin: 5px 0 0 0; font-size: 16px; font-weight: 600;">Index: ‚Çπ<span id="niftyPrice">Loading...</span></p>
                        </div>
                        <button class="btn btn-buy" onclick="refreshOptions()" style="padding: 8px 16px; font-size: 14px;">üîÑ Refresh</button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center; position: relative;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" id="optionSearch" placeholder="Search options (e.g., 25500 CE, 25600 PE)" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
                            <div id="autocompleteDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        <button class="btn btn-buy" onclick="searchOptions()" style="padding: 10px 20px;">Search</button>
                        <button class="btn" onclick="showATMOptions()" style="background: #95a5a6; color: white; padding: 10px 20px;">Show ATM</button>
                    </div>
                </div>
                <div class="options-grid" id="optionsGrid"></div>
            </div>
            <div id="futures" class="tab-content">
                <div class="stocks-grid" id="futuresGrid"></div>
            </div>
            <div id="index" class="tab-content">
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div class="index-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">NIFTY 50</h3>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;" id="niftyIndexPrice">Loading...</div>
                            <div style="font-size: 14px; font-weight: 500;" id="niftyIndexChange">--</div>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="openChart('NIFTY')" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; font-size: 14px; font-weight: 600;">üìà Chart</button>
                            </div>
                        </div>
                        <div class="index-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">BANK NIFTY</h3>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;" id="bankniftyIndexPrice">Loading...</div>
                            <div style="font-size: 14px; font-weight: 500;" id="bankniftyIndexChange">--</div>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="openChart('BANKNIFTY')" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; font-size: 14px; font-weight: 600;">üìà Chart</button>
                            </div>
                        </div>
                        <div class="index-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">INDIA VIX</h3>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;" id="vixIndexPrice">Loading...</div>
                            <div style="font-size: 14px; font-weight: 500;" id="vixIndexChange">--</div>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="openChart('VIX')" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; font-size: 14px; font-weight: 600;">üìà Chart</button>
                            </div>
                        </div>
                        <div class="index-card" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">SENSEX</h3>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;" id="sensexIndexPrice">Loading...</div>
                            <div style="font-size: 14px; font-weight: 500;" id="sensexIndexChange">--</div>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="openChart('SENSEX')" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; font-size: 14px; font-weight: 600;">üìà Chart</button>
                            </div>
                        </div>
                    </div>
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Market Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">Market Status</div>
                                <div style="font-size: 16px; font-weight: 600; color: #27ae60;" id="marketStatus">Open</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">Last Updated</div>
                                <div style="font-size: 16px; font-weight: 600; color: #2c3e50;" id="lastUpdated">--</div>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 16px;">Day Ranges</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea;">
                                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">NIFTY 50</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #2c3e50;" id="niftyDayRange">--</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #e74c3c;">
                                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">BANK NIFTY</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #2c3e50;" id="bankniftyDayRange">--</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60;">
                                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">SENSEX</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #2c3e50;" id="sensexDayRange">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="strategies" class="tab-content">
                <div style="padding: 20px;">
                    <button class="btn btn-buy" onclick="openStrategyModal()" style="margin-bottom: 15px;">+ Create Strategy</button>
                    <div id="strategiesList"></div>
                </div>
            </div>
            <div id="learn" class="tab-content">
                <div style="padding: 30px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìö Learn Options Trading</h3>
                    <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Master options trading with these carefully selected educational videos</p>
                    <div class="video-grid" id="videoGrid"></div>
                </div>
            </div>
            <div id="profile" class="tab-content">
                <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
                    <div style="background: var(--bg-secondary); border-radius: 20px; padding: 40px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
                        <div style="text-align: center; margin-bottom: 40px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: 700; margin: 0 auto 20px; border: 4px solid var(--border-color);">
                                <span id="profileInitial">U</span>
                            </div>
                            <h2 style="color: var(--text-primary); margin: 0 0 10px 0;" id="profileUserName">User Profile</h2>
                            <p style="color: var(--text-secondary); margin: 0;">OptionsPaye Premium Trader</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                            <div style="background: var(--border-color); padding: 25px; border-radius: 15px;">
                                <h4 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                                    <span>üí∞</span> Account Balance
                                </h4>
                                <p style="font-size: 24px; font-weight: 700; color: #27ae60; margin: 0;">‚Çπ<span id="profileBalance">0</span></p>
                            </div>
                            <div style="background: var(--border-color); padding: 25px; border-radius: 15px;">
                                <h4 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                                    <span>üìà</span> Active Positions
                                </h4>
                                <p style="font-size: 24px; font-weight: 700; color: #3498db; margin: 0;" id="activePositions">0</p>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 20px;">
                            <div style="background: var(--border-color); padding: 25px; border-radius: 15px;">
                                <h4 style="color: var(--text-primary); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                    <span>‚öôÔ∏è</span> Application Settings
                                </h4>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color);">
                                    <div>
                                        <div style="color: var(--text-primary); font-weight: 600;">Dark Theme</div>
                                        <div style="color: var(--text-secondary); font-size: 13px;">Switch between light and dark mode</div>
                                    </div>
                                    <label class="theme-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                        <input type="checkbox" id="profileThemeToggle" onchange="toggleTheme()" style="opacity: 0; width: 0; height: 0;">
                                        <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px;"></span>
                                        <span class="slider-dot" style="position: absolute; content: ''; height: 24px; width: 24px; left: 3px; bottom: 3px; background-color: white; transition: transform .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                    </label>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color);">
                                    <div>
                                        <div style="color: var(--text-primary); font-weight: 600;">Push Notifications</div>
                                        <div style="color: var(--text-secondary); font-size: 13px;">Receive trade alerts and updates</div>
                                    </div>
                                    <label class="theme-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                                        <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3498db; transition: .4s; border-radius: 30px;"></span>
                                        <span class="slider-dot" style="position: absolute; content: ''; height: 24px; width: 24px; right: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                    </label>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color);">
                                    <div>
                                        <div style="color: var(--text-primary); font-weight: 600;">Auto-refresh Data</div>
                                        <div style="color: var(--text-secondary); font-size: 13px;">Automatically update market data</div>
                                    </div>
                                    <label class="theme-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                        <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                                        <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3498db; transition: .4s; border-radius: 30px;"></span>
                                        <span class="slider-dot" style="position: absolute; content: ''; height: 24px; width: 24px; right: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="openAddFunds()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                    üí≥ Add Funds
                                </button>
                                <button onclick="openWithdrawFunds()" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                    üí∞ Withdraw
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <button onclick="showTransactionHistory()" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                    üìÑ Transaction History
                                </button>
                                <a href="/logout" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center;">
                                    üö™ Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Buy Option <small style="color: #7f8c8d; font-weight: normal;">(Drag to move)</small></h3>
                <span class="close">&times;</span>
            </div>
            <form id="tradeForm">
                <div class="form-group">
                    <label>Symbol:</label>
                    <input type="text" id="tradeSymbol" readonly>
                </div>
                <div class="form-group">
                    <label>Lots:</label>
                    <input type="number" id="tradeQuantity" min="1" value="1" required onchange="calculateMargin()">
                    <small style="color: #7f8c8d;">1 lot = <span id="lotSize">25</span> quantity</small>
                </div>
                <div class="form-group">
                    <label>Price per unit:</label>
                    <input type="number" id="tradePrice" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Order Type:</label>
                    <select id="orderType" onchange="calculateMargin()" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
                        <option value="NRML">NRML (Normal)</option>
                        <option value="MIS">MIS (Intraday)</option>
                    </select>
                </div>
                <div style="background: rgba(52,152,219,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Quantity:</span>
                        <span id="totalQuantity">25</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Value:</span>
                        <span id="totalValue">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600; color: #2c3e50;">
                        <span>Margin Required:</span>
                        <span id="marginRequired">‚Çπ0</span>
                    </div>
                </div>
                <button type="submit" class="btn" id="tradeButton">Buy</button>
            </form>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div id="addFundsModal" class="modal">
        <div class="modal-content" style="width: 420px; max-width: 95vw; height: 480px; max-height: 90vh; background: var(--bg-secondary); color: var(--text-primary); cursor: move; overflow-y: auto;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color); cursor: move; user-select: none; padding: 15px 20px; position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                <h3 style="color: var(--text-primary); margin: 0; font-size: 18px;">Add Funds <small style="color: var(--text-secondary); font-weight: normal;">(Drag)</small></h3>
                <span class="close" onclick="closeAddFunds()" style="color: var(--text-secondary); font-size: 24px;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="color: var(--text-primary); font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px;">Enter Amount</label>
                    <input type="number" id="fundAmount" placeholder="Enter amount" min="100" max="500000" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button onclick="setAmount(1000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">+1K</button>
                        <button onclick="setAmount(5000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">+5K</button>
                        <button onclick="setAmount(10000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">+10K</button>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label style="color: var(--text-primary); font-weight: 600; margin-bottom: 12px; display: block; font-size: 14px;">Payment Method</label>
                    <div style="display: grid; gap: 8px;">
                        <div class="payment-option" onclick="selectPayment('upi')" style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #ff6b35, #f7931e); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">UPI</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">UPI Payment</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Any UPI app</div>
                            </div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('phonepe')" style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #5f259f, #3c1361); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">PE</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">PhonePe</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Quick payments</div>
                            </div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('gpay')" style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #4285f4, #34a853); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">GP</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Google Pay</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Google Pay</div>
                            </div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('netbanking')" style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #2c3e50, #34495e); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">NB</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Net Banking</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">All banks</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="processFundAddition()" class="btn btn-buy" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600;">Proceed to Pay</button>
                    <button onclick="closeAddFunds()" class="btn" style="background: var(--border-color); color: var(--text-primary); flex: 1; padding: 12px; font-size: 14px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Funds Modal -->
    <div id="withdrawFundsModal" class="modal">
        <div class="modal-content" style="width: 420px; max-width: 95vw; height: 400px; max-height: 90vh; background: var(--bg-secondary); color: var(--text-primary); cursor: move; overflow-y: auto;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color); cursor: move; user-select: none; padding: 15px 20px; position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                <h3 style="color: var(--text-primary); margin: 0; font-size: 18px;">Withdraw Funds <small style="color: var(--text-secondary); font-weight: normal;">(Drag)</small></h3>
                <span class="close" onclick="closeWithdrawFunds()" style="color: var(--text-secondary); font-size: 24px;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="color: var(--text-primary); font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px;">Available Balance</label>
                    <div style="background: var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #27ae60;">‚Çπ<span id="availableBalance">0</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: var(--text-primary); font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px;">Withdraw Amount</label>
                    <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw" min="100" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button onclick="setWithdrawAmount(1000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">1K</button>
                        <button onclick="setWithdrawAmount(5000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">5K</button>
                        <button onclick="setWithdrawAmount(10000)" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">10K</button>
                        <button onclick="setWithdrawAllAmount()" style="padding: 6px 12px; background: var(--border-color); border: none; border-radius: 15px; color: var(--text-primary); cursor: pointer; font-size: 12px;">All</button>
                    </div>
                </div>
                <div style="background: rgba(231,76,60,0.1); padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #e74c3c;">
                    <div style="font-size: 13px; color: #c0392b; line-height: 1.4;">
                        <strong>‚ö†Ô∏è Withdrawal Information:</strong><br>
                        ‚Ä¢ Funds will be credited to your registered bank account<br>
                        ‚Ä¢ Processing time: 2-3 business days<br>
                        ‚Ä¢ No withdrawal charges
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="processWithdrawal()" class="btn btn-sell" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600;">Withdraw Funds</button>
                    <button onclick="closeWithdrawFunds()" class="btn" style="background: var(--border-color); color: var(--text-primary); flex: 1; padding: 12px; font-size: 14px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Assistant -->
    <div id="chatBot" style="position: fixed; bottom: 20px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1001; display: none; flex-direction: column;">
        <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0;">ü§ñ AI Market News</h4>
            <span onclick="toggleChatBot()" style="cursor: pointer; font-size: 20px;">&times;</span>
        </div>
        <div id="chatMessages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa;">
            <div class="chat-message bot-message">
                <div style="background: #e9ecef; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                    <strong>AI Assistant:</strong> Hi! I can help you with market news and updates. Ask me about NIFTY, market trends, or any stock!
                </div>
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="Ask about market news..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;">
                <button onclick="sendMessage()" style="background: #9b59b6; color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <!-- Strategy Creation Modal -->
    <div id="strategyModal" class="modal">
        <div class="modal-content" style="width: 700px; max-width: 95vw; height: 500px; max-height: 90vh; cursor: move; overflow-y: auto;">
            <div class="modal-header" style="cursor: move; user-select: none; padding: 15px 20px; position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #eee;">
                <h3 style="margin: 0; font-size: 18px;">OptionsPaye Strategy Builder <small style="color: #7f8c8d; font-weight: normal;">(Drag)</small></h3>
                <span class="close" onclick="closeStrategyModal()" style="font-size: 24px;">&times;</span>
            </div>
            <form id="strategyForm" style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Strategy Name:</label>
                        <input type="text" id="strategyName" placeholder="My Strategy" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Strategy Type:</label>
                        <select id="strategyType" onchange="updateStrategyDescription()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="long_straddle">Long Straddle</option>
                            <option value="short_straddle">Short Straddle</option>
                            <option value="long_strangle">Long Strangle</option>
                            <option value="short_strangle">Short Strangle</option>
                            <option value="iron_condor">Iron Condor</option>
                            <option value="butterfly">Butterfly Spread</option>
                            <option value="custom">Custom Strategy</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Strike Price:</label>
                        <input type="number" id="strikePrice" placeholder="24500" step="50" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Expiry:</label>
                        <select id="expiryDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Lots:</label>
                        <input type="number" id="strategyLots" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Max Loss (% Capital):</label>
                        <input type="number" id="maxLossPercent" min="1" max="50" value="5" step="0.5" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div id="customStrategyOptions" style="display: none;">
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Stop Loss Type:</label>
                        <select id="stopLossType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="capital_deployed">Capital Deployed</option>
                            <option value="total_funds">Total Portfolio</option>
                        </select>
                    </div>
                </div>
                <div id="customStrategyOptionsRow2" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Stop Loss %:</label>
                            <input type="number" id="stopLossPercent" min="5" max="100" value="20" step="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Target Profit %:</label>
                            <input type="number" id="targetProfit" min="10" max="500" value="50" step="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px;">Strategy Info:</h4>
                    <p id="strategyDescription" style="margin: 0; font-size: 12px; line-height: 1.4; opacity: 0.9;">Select a strategy to see description</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-buy" style="flex: 1; padding: 10px;">Create Strategy</button>
                    <button type="button" class="btn" onclick="closeStrategyModal()" style="background: #95a5a6; color: white; flex: 1; padding: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SEBI Disclosure Modal -->
    <div id="sebiModal" class="modal" style="display: block;">
        <div class="modal-content" style="width: 600px; max-width: 90vw;">
            <div class="modal-header">
                <h3 style="color: #e74c3c;">‚ö†Ô∏è Risk Disclosures on Derivatives</h3>
            </div>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <p style="margin-bottom: 15px; font-weight: 600; color: #856404;">Important SEBI Disclosure:</p>
                <ul style="margin-left: 20px; color: #856404; line-height: 1.6;">
                    <li><strong>9 out of 10 individual traders</strong> in equity Futures and Options Segment, incurred net losses.</li>
                    <li>On an average, <strong>loss makers registered net trading loss close to ‚Çπ50,000</strong>.</li>
                    <li>Over and above the net trading losses incurred, loss makers expended an <strong>additional 28% of net trading losses as transaction costs</strong>.</li>
                    <li>Those making net trading profits, incurred <strong>between 15% to 50% of such profits as transaction cost</strong>.</li>
                </ul>
                <p style="margin-top: 15px; font-size: 12px; color: #6c757d;">Source: SEBI study dated January 25, 2023 on "Analysis of Profit and Loss of Individual Traders dealing in equity Futures and Options (F&O) Segment", wherein Aggregate Level findings are based on annual Profit/Loss incurred by individual traders in equity F&O during FY 2021-22.</p>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-buy" onclick="acceptSebiDisclosure()" style="padding: 12px 30px; font-size: 16px;">I Understand</button>
            </div>
        </div>
    </div>

    <script>
        let currentAction = '';
        let stocks = [];
        let futures = [];
        let options = [];
        let currentOption = {};
        
        // Educational videos data
        const educationalVideos = [
            {
                id: 'VhwQzVR5a7E',
                title: 'Options Trading for Beginners - Complete Guide',
                channel: 'Zerodha Varsity',
                duration: '45:32'
            },
            {
                id: 'SD7sw0bf1ms',
                title: 'Understanding Option Greeks - Delta, Gamma, Theta, Vega',
                channel: 'CA Rachana Ranade',
                duration: '28:15'
            },
            {
                id: 'ZJjRnKpwDyw',
                title: 'Options Strategies - Straddle, Strangle, Iron Condor',
                channel: 'Pranjal Kamra',
                duration: '35:42'
            },
            {
                id: 'rtVFj-qRhBo',
                title: 'Risk Management in Options Trading',
                channel: 'Trade Brains',
                duration: '22:18'
            },
            {
                id: 'GxmIvvROge4',
                title: 'How to Read Option Chain - Live Example',
                channel: 'Stock Edge',
                duration: '31:25'
            },
            {
                id: 'ZNVQ9kYTASY',
                title: 'Options Trading Psychology and Discipline',
                channel: 'Finnovationz',
                duration: '26:33'
            }
        ];
        
        function loadEducationalVideos() {
            const videoGrid = document.getElementById('videoGrid');
            videoGrid.innerHTML = '';
            
            educationalVideos.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.onclick = () => openVideo(video.id);
                
                videoCard.innerHTML = `
                    <div class="video-thumbnail" style="background-image: url('https://img.youtube.com/vi/${video.id}/maxresdefault.jpg');">
                        <div class="play-button">‚ñ∂</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <div class="video-channel">${video.channel}</div>
                        <div class="video-duration">üïí ${video.duration}</div>
                    </div>
                `;
                
                videoGrid.appendChild(videoCard);
            });
        }
        
        function openVideo(videoId) {
            window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
        }
        
        function loadIndexData() {
            // Check if market is open
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            const marketOpen = 9 * 60 + 15;
            const marketClose = 15 * 60 + 30;
            const isMarketOpen = (day >= 1 && day <= 5) && (currentTime >= marketOpen && currentTime <= marketClose);
            
            // Load NIFTY 50
            fetch('/api/nifty-price')
                .then(response => response.json())
                .then(data => {
                    const price = data.price;
                    let change = isMarketOpen ? (Math.random() - 0.5) * 2 : (data.change || 0);
                    let changePercent = (change / price * 100);
                    
                    document.getElementById('niftyIndexPrice').textContent = '‚Çπ' + price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    const changeElement = document.getElementById('niftyIndexChange');
                    changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                    changeElement.style.color = change >= 0 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)';
                    
                    // Calculate NIFTY day range
                    const niftyLow = (price - 50).toFixed(2);
                    const niftyHigh = (price + 50).toFixed(2);
                    document.getElementById('niftyDayRange').textContent = `‚Çπ${niftyLow} - ‚Çπ${niftyHigh}`;
                });
            
            // Load Bank Nifty (simulated)
            const bankNiftyPrice = 51250 + (Math.random() - 0.5) * 100;
            const bankNiftyChange = isMarketOpen ? (Math.random() - 0.5) * 3 : -0.5;
            const bankNiftyChangePercent = (bankNiftyChange / bankNiftyPrice * 100);
            document.getElementById('bankniftyIndexPrice').textContent = '‚Çπ' + bankNiftyPrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const bankNiftyChangeElement = document.getElementById('bankniftyIndexChange');
            bankNiftyChangeElement.textContent = `${bankNiftyChange >= 0 ? '+' : ''}${bankNiftyChange.toFixed(2)} (${bankNiftyChangePercent >= 0 ? '+' : ''}${bankNiftyChangePercent.toFixed(2)}%)`;
            bankNiftyChangeElement.style.color = bankNiftyChange >= 0 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)';
            
            // Calculate Bank Nifty day range
            const bankNiftyLow = (bankNiftyPrice - 150).toFixed(2);
            const bankNiftyHigh = (bankNiftyPrice + 150).toFixed(2);
            document.getElementById('bankniftyDayRange').textContent = `‚Çπ${bankNiftyLow} - ‚Çπ${bankNiftyHigh}`;
            
            // Load India VIX (simulated)
            const vixPrice = 13.5 + (Math.random() - 0.5) * 2;
            const vixChange = isMarketOpen ? (Math.random() - 0.5) * 1.5 : 0.2;
            const vixChangePercent = (vixChange / vixPrice * 100);
            document.getElementById('vixIndexPrice').textContent = vixPrice.toFixed(2);
            const vixChangeElement = document.getElementById('vixIndexChange');
            vixChangeElement.textContent = `${vixChange >= 0 ? '+' : ''}${vixChange.toFixed(2)} (${vixChangePercent >= 0 ? '+' : ''}${vixChangePercent.toFixed(2)}%)`;
            vixChangeElement.style.color = vixChange >= 0 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)';
            
            // Load Sensex (simulated)
            const sensexPrice = 81200 + (Math.random() - 0.5) * 200;
            const sensexChange = isMarketOpen ? (Math.random() - 0.5) * 4 : 1.2;
            const sensexChangePercent = (sensexChange / sensexPrice * 100);
            document.getElementById('sensexIndexPrice').textContent = '‚Çπ' + sensexPrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const sensexChangeElement = document.getElementById('sensexIndexChange');
            sensexChangeElement.textContent = `${sensexChange >= 0 ? '+' : ''}${sensexChange.toFixed(2)} (${sensexChangePercent >= 0 ? '+' : ''}${sensexChangePercent.toFixed(2)}%)`;
            sensexChangeElement.style.color = sensexChange >= 0 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)';
            
            // Calculate Sensex day range
            const sensexLow = (sensexPrice - 200).toFixed(2);
            const sensexHigh = (sensexPrice + 200).toFixed(2);
            document.getElementById('sensexDayRange').textContent = `‚Çπ${sensexLow} - ‚Çπ${sensexHigh}`;
            
            // Update market info
            document.getElementById('marketStatus').textContent = isMarketOpen ? 'Open' : 'Closed';
            document.getElementById('marketStatus').style.color = isMarketOpen ? '#27ae60' : '#e74c3c';
            document.getElementById('lastUpdated').textContent = isMarketOpen ? 'Live' : 'Previous Close';
        }
        
        function openChart(index) {
            let symbol;
            switch(index) {
                case 'NIFTY':
                    symbol = 'NSE:NIFTY';
                    break;
                case 'BANKNIFTY':
                    symbol = 'NSE:BANKNIFTY';
                    break;
                case 'VIX':
                    symbol = 'NSE:INDIAVIX';
                    break;
                case 'SENSEX':
                    symbol = 'BSE:SENSEX';
                    break;
                default:
                    symbol = 'NSE:NIFTY';
            }
            const chartUrl = `https://in.tradingview.com/chart/?symbol=${symbol}&interval=5`;
            window.open(chartUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }
        
        function toggleChatBot() {
            const chatBot = document.getElementById('chatBot');
            chatBot.style.display = chatBot.style.display === 'none' ? 'flex' : 'none';
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const response = generateAIResponse(message);
                addChatMessage(response, 'bot');
            }, 1000);
        }
        
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div style="background: #9b59b6; color: white; padding: 10px; border-radius: 10px; margin-bottom: 10px; margin-left: 50px; text-align: right;">
                        ${message}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="background: #e9ecef; padding: 10px; border-radius: 10px; margin-bottom: 10px; margin-right: 50px;">
                        <strong>AI Assistant:</strong> ${message}
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Market news responses based on keywords
            if (message.includes('nifty') || message.includes('index')) {
                return 'NIFTY 50 is currently showing consolidation around key support levels. Market sentiment remains cautious due to global cues. Key levels to watch: Support at 24,200 and resistance at 24,800.';
            } else if (message.includes('market') || message.includes('news')) {
                return 'Today\'s market highlights: ‚Ä¢ FII activity remains mixed ‚Ä¢ Banking sector showing resilience ‚Ä¢ IT stocks under pressure due to global concerns ‚Ä¢ Auto sector gaining momentum on festive demand';
            } else if (message.includes('options') || message.includes('trading')) {
                return 'Options trading update: High volatility expected around monthly expiry. PCR ratio suggests bullish sentiment. Consider protective strategies given current market uncertainty.';
            } else if (message.includes('volatility') || message.includes('vix')) {
                return 'India VIX is currently elevated, indicating higher market volatility. This creates opportunities for options traders but requires careful risk management.';
            } else if (message.includes('bank') || message.includes('banking')) {
                return 'Banking sector news: PSU banks outperforming private banks. Credit growth remains healthy. RBI policy stance continues to support the sector.';
            } else {
                const responses = [
                    'Market is showing mixed signals today. Keep an eye on global cues and domestic developments.',
                    'Current market trend suggests range-bound movement. Look for breakout opportunities.',
                    'FII and DII flows are key factors to watch. Domestic institutional support remains strong.',
                    'Sectoral rotation is happening. Technology and pharma showing relative strength.',
                    'Earnings season approaching - focus on companies with strong fundamentals.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        function calculateMargin() {
            const lots = parseInt(document.getElementById('tradeQuantity').value) || 1;
            const price = parseFloat(document.getElementById('tradePrice').value) || 0;
            const lotSize = parseInt(document.getElementById('lotSize').textContent) || 25;
            const orderType = document.getElementById('orderType').value;
            
            const totalQuantity = lots * lotSize;
            const totalValue = price * totalQuantity;
            const margin = orderType === 'NRML' ? totalValue : totalValue * 0.8;
            
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalValue').textContent = '‚Çπ' + totalValue.toFixed(2);
            document.getElementById('marginRequired').textContent = '‚Çπ' + margin.toFixed(2);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load content when specific tabs are opened
            if (tabName === 'learn') {
                loadEducationalVideos();
            } else if (tabName === 'index') {
                loadIndexData();
            } else if (tabName === 'strategies') {
                loadStrategies();
            } else if (tabName === 'profile') {
                updateProfileData();
            } else if (tabName === 'options') {
                fetch('/api/real-options')
                    .then(response => response.json())
                    .then(data => {
                        options = data;
                        displayOptions(data);
                    })
                    .catch(() => {
                        // Fallback to simulated data if real API fails
                        fetch('/api/options?atm=true')
                            .then(response => response.json())
                            .then(data => {
                                options = data;
                                displayOptions(data);
                            });
                    });
            }
        }

        function loadData() {
            fetch('/api/balance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('balance').textContent = data.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });

            fetch('/api/stocks')
                .then(response => response.json())
                .then(data => {
                    stocks = data;
                    displayStocks(data);
                });

            fetch('/api/futures')
                .then(response => response.json())
                .then(data => {
                    futures = data;
                    displayFutures(data);
                });

            fetch('/api/options?atm=true')
                .then(response => response.json())
                .then(data => {
                    options = data;
                    displayOptions(data);
                });

            fetch('/api/nifty-price')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('niftyPrice').textContent = data.price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });

            fetch('/api/fo-portfolio')
                .then(response => response.json())
                .then(data => {
                    displayFOPortfolio(data);
                });
        }

        function displayStocks(stocks) {
            const grid = document.getElementById('stocksGrid');
            grid.innerHTML = '';
            
            stocks.forEach(stock => {
                const card = document.createElement('div');
                card.className = 'stock-card';
                card.innerHTML = `
                    <div class="stock-header">
                        <div>
                            <div class="stock-symbol">${stock.symbol}</div>
                            <div style="font-size: 12px; color: #666;">${stock.name}</div>
                        </div>
                        <div class="stock-price ${stock.change >= 0 ? 'positive' : 'negative'}">
                            ‚Çπ${stock.price}
                        </div>
                    </div>
                    <div class="${stock.change >= 0 ? 'positive' : 'negative'}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change}%
                    </div>
                    <div class="stock-actions">
                        <button class="btn btn-buy" onclick="openTradeModal('${stock.symbol}', ${stock.price}, 'buy')">Buy</button>
                        <button class="btn btn-sell" onclick="openTradeModal('${stock.symbol}', ${stock.price}, 'sell')">Sell</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function displayFOPortfolio(portfolio) {
            const tbody = document.getElementById('foPortfolioBody');
            tbody.innerHTML = '';
            
            if (portfolio.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #7f8c8d; padding: 30px;">No F&O positions yet. Start trading options!</td></tr>';
                return;
            }
            
            portfolio.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${item.symbol}</td>
                    <td>${item.strike}</td>
                    <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; background: ${item.type === 'CE' ? '#e8f5e8' : '#ffe8e8'}; color: ${item.type === 'CE' ? '#27ae60' : '#e74c3c'};">${item.type}</span></td>
                    <td>${item.quantity}</td>
                    <td>‚Çπ${item.avg_price.toFixed(2)}</td>
                    <td>‚Çπ${item.current_price.toFixed(2)}</td>
                    <td class="${item.pnl >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">‚Çπ${item.pnl}</td>
                    <td class="${item.pnl_percent >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${item.pnl_percent}%</td>
                    <td><button class="btn btn-sell" onclick="exitPosition('${item.symbol}', ${item.quantity})" style="padding: 4px 8px; font-size: 12px;">Exit</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayFutures(futures) {
            const grid = document.getElementById('futuresGrid');
            grid.innerHTML = '';
            
            futures.forEach(fut => {
                const card = document.createElement('div');
                card.className = 'stock-card';
                card.innerHTML = `
                    <div class="stock-header">
                        <div>
                            <div class="stock-symbol">${fut.symbol}</div>
                            <div style="font-size: 13px; color: #7f8c8d; font-weight: 500;">${fut.name} ‚Ä¢ Lot: ${fut.lot_size}</div>
                        </div>
                        <div class="stock-price ${fut.change >= 0 ? 'positive' : 'negative'}">
                            ‚Çπ${fut.price.toLocaleString()}
                        </div>
                    </div>
                    <div class="${fut.change >= 0 ? 'positive' : 'negative'}" style="font-weight: 600; margin-bottom: 15px;">
                        ${fut.change >= 0 ? '+' : ''}${fut.change}%
                    </div>
                    <div class="stock-actions">
                        <button class="btn btn-buy" onclick="openTradeModal('${fut.symbol}', ${fut.price}, 'buy')">Buy</button>
                        <button class="btn btn-sell" onclick="openTradeModal('${fut.symbol}', ${fut.price}, 'sell')">Sell</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function displayOptions(options) {
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            if (options.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 30px;">No options found. Try searching or refresh the chain.</p>';
                return;
            }
            
            // Get current NIFTY price for classification
            fetch('/api/nifty-price')
                .then(response => response.json())
                .then(data => {
                    const niftyPrice = data.price;
                    
                    // Separate options by moneyness
                    const ceOptions = options.filter(opt => opt.type === 'CE').sort((a, b) => a.strike - b.strike);
                    const peOptions = options.filter(opt => opt.type === 'PE').sort((a, b) => a.strike - b.strike);
                    
                    // Create organized display
                    grid.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;">
                            <div>
                                <h4 style="color: #27ae60; margin-bottom: 15px; text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">CALL OPTIONS (CE)</h4>
                                <div id="ceOptionsContainer"></div>
                            </div>
                            <div>
                                <h4 style="color: #e74c3c; margin-bottom: 15px; text-align: center; padding: 10px; background: #ffe8e8; border-radius: 8px;">PUT OPTIONS (PE)</h4>
                                <div id="peOptionsContainer"></div>
                            </div>
                        </div>
                    `;
                    
                    displayOptionsList(ceOptions, 'ceOptionsContainer', niftyPrice, 'CE');
                    displayOptionsList(peOptions, 'peOptionsContainer', niftyPrice, 'PE');
                });
        }
        
        function getLastTuesdayOfMonth(year, month) {
            // Get last day of month
            const lastDay = new Date(year, month + 1, 0);
            // Find last Tuesday (day 2 = Tuesday)
            const lastTuesday = new Date(lastDay);
            lastTuesday.setDate(lastDay.getDate() - ((lastDay.getDay() + 5) % 7));
            return lastTuesday;
        }
        
        function getOrdinalNumber(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const value = num % 100;
            return num + (suffixes[(value - 20) % 10] || suffixes[value] || suffixes[0]);
        }
        
        function displayOptionsList(options, containerId, niftyPrice, optionType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            options.forEach(opt => {
                // Calculate realistic option price
                const isITM = (optionType === 'CE' && opt.strike < niftyPrice) || (optionType === 'PE' && opt.strike > niftyPrice);
                const isATM = Math.abs(opt.strike - niftyPrice) <= 50;
                const moneyness = isATM ? 'ATM' : (isITM ? 'ITM' : 'OTM');
                
                // Use actual option price from API data
                const actualPrice = opt.price || 0;
                
                const optionRow = document.createElement('div');
                const bgColor = isATM ? '#fff3cd' : (isITM ? '#d4edda' : '#f8f9fa');
                const borderColor = isATM ? '#ffc107' : (isITM ? '#28a745' : '#6c757d');
                
                optionRow.style.cssText = `
                    display: flex; justify-content: space-between; align-items: center; 
                    padding: 12px; margin-bottom: 8px; background: ${bgColor}; border-radius: 8px; 
                    border-left: 4px solid ${borderColor};
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
                `;
                
                // Format expiry date for NIFTY Tuesday expiries
                const expiryDate = new Date(opt.expiry);
                const day = expiryDate.getDate();
                const month = expiryDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                
                // Check if this is the last Tuesday of the month (monthly expiry)
                const lastTuesdayOfMonth = getLastTuesdayOfMonth(expiryDate.getFullYear(), expiryDate.getMonth());
                const isMonthlyExpiry = day === lastTuesdayOfMonth.getDate();
                
                let displaySymbol;
                if (isMonthlyExpiry) {
                    // Monthly expiry format: NIFTY DEC 22000 CE
                    displaySymbol = `NIFTY ${month} ${opt.strike} ${optionType}`;
                } else {
                    // Weekly expiry format: NIFTY 11th w NOV 25450 CE
                    const ordinalDay = getOrdinalNumber(day);
                    displaySymbol = `NIFTY ${ordinalDay} w ${month} ${opt.strike} ${optionType}`;
                }
                
                optionRow.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px; font-size: 13px;">
                            ${displaySymbol}
                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 3px; background: ${isATM ? '#ffc107' : (isITM ? '#28a745' : '#6c757d')}; color: white; margin-left: 8px;">${moneyness}</span>
                        </div>
                        <div style="font-size: 11px; color: #7f8c8d;">
                            Œî: ${opt.delta.toFixed(2)} | IV: ${(opt.iv * 100).toFixed(1)}% | Exp: ${expiryDate.toLocaleDateString('en-IN')}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
                            ‚Çπ${actualPrice.toFixed(2)}
                        </div>
                        <div style="font-size: 11px; color: ${opt.change >= 0 ? '#27ae60' : '#e74c3c'};">
                            ${opt.change >= 0 ? '+' : ''}${opt.change.toFixed(1)}%
                        </div>
                    </div>
                    <div style="margin-left: 15px;">
                        <button onclick="openTradeModal('${opt.symbol}', ${actualPrice.toFixed(2)}, 'buy')" 
                                style="background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; margin-right: 5px; cursor: pointer;">Buy</button>
                        <button onclick="openTradeModal('${opt.symbol}', ${actualPrice.toFixed(2)}, 'sell')" 
                                style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Sell</button>
                    </div>
                `;
                
                container.appendChild(optionRow);
            });
        }

        function openTradeModal(symbol, price, action) {
            currentAction = action;
            
            const option = options.find(opt => opt.symbol === symbol);
            if (option) {
                currentOption = option;
                document.getElementById('lotSize').textContent = option.lot_size;
            }
            
            document.getElementById('modalTitle').textContent = action === 'buy' ? 'Buy Option' : 'Sell Option';
            document.getElementById('tradeSymbol').value = symbol;
            document.getElementById('tradePrice').value = price;
            document.getElementById('tradeQuantity').value = '1';
            document.getElementById('tradeButton').textContent = action === 'buy' ? 'Buy' : 'Sell';
            document.getElementById('tradeButton').className = action === 'buy' ? 'btn btn-buy' : 'btn btn-sell';
            
            calculateMargin();
            document.getElementById('tradeModal').style.display = 'block';
        }

        document.querySelector('.close').onclick = function() {
            document.getElementById('tradeModal').style.display = 'none';
        }

        document.getElementById('tradeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('tradeSymbol').value;
            const quantity = document.getElementById('tradeQuantity').value;
            
            const orderType = document.getElementById('orderType').value;
            
            fetch(`/api/${currentAction}-option`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: symbol,
                    quantity: parseInt(quantity),
                    order_type: orderType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('tradeModal').style.display = 'none';
                    loadData();
                } else {
                    alert(data.error);
                }
            });
        });

        function searchOptions() {
            const searchTerm = document.getElementById('optionSearch').value;
            // Filter from loaded real options data
            const filteredOptions = options.filter(opt => 
                opt.symbol.includes(searchTerm.toUpperCase()) || 
                opt.strike.toString().includes(searchTerm) ||
                opt.type.includes(searchTerm.toUpperCase())
            );
            displayOptions(filteredOptions);
        }

        function showATMOptions() {
            document.getElementById('optionSearch').value = '';
            fetch('/api/real-options')
                .then(response => response.json())
                .then(data => {
                    options = data;
                    displayOptions(data);
                })
                .catch(() => {
                    fetch('/api/options?atm=true')
                        .then(response => response.json())
                        .then(data => {
                            options = data;
                            displayOptions(data);
                        });
                });
        }

        function refreshOptions() {
            fetch('/api/refresh-options', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showATMOptions(); // Show ATM after refresh
                    loadData(); // Reload other data
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert('‚ùå Failed to refresh options chain');
                }
            });
        }

        function exitPosition(symbol, quantity) {
            if (confirm(`Exit ${quantity} lots of ${symbol}?`)) {
                fetch('/api/sell-option', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        quantity: quantity,
                        order_type: 'NRML'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadData();
                        alert('‚úÖ Position exited successfully!');
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }

        function exitAllPositions() {
            if (confirm('Are you sure you want to exit ALL F&O positions? This action cannot be undone.')) {
                fetch('/api/exit-all-positions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadData();
                        alert(`‚úÖ ${data.message}`);
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }

        function acceptSebiDisclosure() {
            document.getElementById('sebiModal').style.display = 'none';
            sessionStorage.setItem('sebiAccepted', 'true');
        }

        // Modal drag functionality
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        
        document.querySelector('.modal-header').addEventListener('mousedown', function(e) {
            isDragging = true;
            const modal = document.querySelector('.modal-content');
            const rect = modal.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            modal.classList.add('dragging');
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const modal = document.querySelector('.modal-content');
                modal.style.position = 'fixed';
                modal.style.left = (e.clientX - dragOffset.x) + 'px';
                modal.style.top = (e.clientY - dragOffset.y) + 'px';
                modal.style.margin = '0';
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                document.querySelector('.modal-content').classList.remove('dragging');
            }
        });

        // Auto-completion functionality
        let autocompleteTimeout;
        const searchInput = document.getElementById('optionSearch');
        const dropdown = document.getElementById('autocompleteDropdown');
        
        searchInput.addEventListener('input', function() {
            clearTimeout(autocompleteTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            
            autocompleteTimeout = setTimeout(() => {
                fetch(`/api/autocomplete-options?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(suggestions => {
                        displayAutocomplete(suggestions);
                    });
            }, 300);
        });
        
        function displayAutocomplete(suggestions) {
            dropdown.innerHTML = '';
            
            if (suggestions.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            suggestions.forEach(opt => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                item.innerHTML = `
                    <div>
                        <strong>${opt.strike} ${opt.type}</strong>
                        <div style="font-size: 12px; color: #7f8c8d;">Exp: ${opt.expiry}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: ${opt.change >= 0 ? '#27ae60' : '#e74c3c'};">‚Çπ${opt.price}</div>
                        <div style="font-size: 11px; color: #7f8c8d;">Œî ${opt.delta.toFixed(2)}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    // Add this option to the display
                    options.push(opt);
                    displayOptions([opt]);
                    dropdown.style.display = 'none';
                    searchInput.value = '';
                });
                
                item.addEventListener('mouseenter', () => {
                    item.style.backgroundColor = '#f8f9fa';
                });
                
                item.addEventListener('mouseleave', () => {
                    item.style.backgroundColor = 'white';
                });
                
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Add Enter key support for search
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                dropdown.style.display = 'none';
                searchOptions();
            }
        });
        
        // Add Enter key support for chat
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function openStrategyModal() {
            document.getElementById('strategyModal').style.display = 'block';
            // Set current NIFTY price as default strike
            fetch('/api/nifty-price')
                .then(response => response.json())
                .then(data => {
                    const roundedPrice = Math.round(data.price / 50) * 50; // Round to nearest 50
                    document.getElementById('strikePrice').value = roundedPrice;
                });
            updateStrategyDescription();
        }
        
        function closeStrategyModal() {
            document.getElementById('strategyModal').style.display = 'none';
        }
        
        function updateStrategyDescription() {
            const strategyType = document.getElementById('strategyType').value;
            const customOptions = document.getElementById('customStrategyOptions');
            
            const descriptions = {
                'long_straddle': 'Buy ATM Call + Buy ATM Put. Profit from high volatility in either direction. Limited risk, unlimited reward.',
                'short_straddle': 'Sell ATM Call + Sell ATM Put. Profit from low volatility. High risk, limited reward. Requires margin.',
                'long_strangle': 'Buy OTM Call + Buy OTM Put. Cheaper than straddle, needs larger moves. Limited risk, unlimited reward.',
                'short_strangle': 'Sell OTM Call + Sell OTM Put. Profit from range-bound movement. High risk, limited reward.',
                'iron_condor': 'Sell Call Spread + Sell Put Spread. Profit from low volatility. Limited risk and reward.',
                'butterfly': 'Buy 1 ITM Call + Sell 2 ATM Calls + Buy 1 OTM Call. Profit from minimal movement. Limited risk and reward.',
                'custom': 'Create your own strategy with custom stop loss and target settings. Define risk management based on capital deployed or total portfolio value.'
            };
            
            document.getElementById('strategyDescription').textContent = descriptions[strategyType];
            
            // Show/hide custom strategy options
            const customOptionsRow2 = document.getElementById('customStrategyOptionsRow2');
            if (strategyType === 'custom') {
                customOptions.style.display = 'block';
                customOptionsRow2.style.display = 'block';
            } else {
                customOptions.style.display = 'none';
                customOptionsRow2.style.display = 'none';
            }
        }
        
        // Modal drag functionality
        let isStrategyDragging = false;
        let isFundsDragging = false;
        let isWithdrawDragging = false;
        let strategyDragOffset = { x: 0, y: 0 };
        let fundsDragOffset = { x: 0, y: 0 };
        let withdrawDragOffset = { x: 0, y: 0 };
        
        // Strategy modal drag
        document.querySelector('#strategyModal .modal-header').addEventListener('mousedown', function(e) {
            isStrategyDragging = true;
            const modal = document.querySelector('#strategyModal .modal-content');
            const rect = modal.getBoundingClientRect();
            strategyDragOffset.x = e.clientX - rect.left;
            strategyDragOffset.y = e.clientY - rect.top;
            modal.classList.add('dragging');
        });
        
        // Add Funds modal drag
        document.querySelector('#addFundsModal .modal-header').addEventListener('mousedown', function(e) {
            isFundsDragging = true;
            const modal = document.querySelector('#addFundsModal .modal-content');
            const rect = modal.getBoundingClientRect();
            fundsDragOffset.x = e.clientX - rect.left;
            fundsDragOffset.y = e.clientY - rect.top;
            modal.classList.add('dragging');
        });
        
        // Withdraw Funds modal drag
        document.querySelector('#withdrawFundsModal .modal-header').addEventListener('mousedown', function(e) {
            isWithdrawDragging = true;
            const modal = document.querySelector('#withdrawFundsModal .modal-content');
            const rect = modal.getBoundingClientRect();
            withdrawDragOffset.x = e.clientX - rect.left;
            withdrawDragOffset.y = e.clientY - rect.top;
            modal.classList.add('dragging');
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isStrategyDragging) {
                const modal = document.querySelector('#strategyModal .modal-content');
                modal.style.position = 'fixed';
                modal.style.left = (e.clientX - strategyDragOffset.x) + 'px';
                modal.style.top = (e.clientY - strategyDragOffset.y) + 'px';
                modal.style.margin = '0';
            }
            if (isFundsDragging) {
                const modal = document.querySelector('#addFundsModal .modal-content');
                modal.style.position = 'fixed';
                modal.style.left = (e.clientX - fundsDragOffset.x) + 'px';
                modal.style.top = (e.clientY - fundsDragOffset.y) + 'px';
                modal.style.margin = '0';
            }
            if (isWithdrawDragging) {
                const modal = document.querySelector('#withdrawFundsModal .modal-content');
                modal.style.position = 'fixed';
                modal.style.left = (e.clientX - withdrawDragOffset.x) + 'px';
                modal.style.top = (e.clientY - withdrawDragOffset.y) + 'px';
                modal.style.margin = '0';
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (isStrategyDragging) {
                isStrategyDragging = false;
                document.querySelector('#strategyModal .modal-content').classList.remove('dragging');
            }
            if (isFundsDragging) {
                isFundsDragging = false;
                document.querySelector('#addFundsModal .modal-content').classList.remove('dragging');
            }
            if (isWithdrawDragging) {
                isWithdrawDragging = false;
                document.querySelector('#withdrawFundsModal .modal-content').classList.remove('dragging');
            }
        });
        
        document.getElementById('strategyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('strategyName').value,
                type: document.getElementById('strategyType').value,
                strike: parseInt(document.getElementById('strikePrice').value),
                expiry: document.getElementById('expiryDate').value,
                lots: parseInt(document.getElementById('strategyLots').value),
                maxLossPercent: parseFloat(document.getElementById('maxLossPercent').value)
            };
            
            // Add custom strategy options if selected
            if (document.getElementById('strategyType').value === 'custom') {
                formData.stopLossType = document.getElementById('stopLossType').value;
                formData.stopLossPercent = parseFloat(document.getElementById('stopLossPercent').value);
                formData.targetProfit = parseFloat(document.getElementById('targetProfit').value);
            }
            
            fetch('/api/create-strategy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeStrategyModal();
                    loadStrategies();
                    alert('‚úÖ Strategy created successfully!');
                } else {
                    alert('‚ùå ' + data.error);
                }
            });
        });
        
        function loadStrategies() {
            fetch('/api/strategies')
                .then(response => response.json())
                .then(strategies => {
                    displayStrategies(strategies);
                });
        }
        
        function displayStrategies(strategies) {
            const strategiesList = document.getElementById('strategiesList');
            strategiesList.innerHTML = '';
            
            if (strategies.length === 0) {
                strategiesList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No strategies created yet. Create your first strategy!</p>';
                return;
            }
            
            strategies.forEach(strategy => {
                const strategyCard = document.createElement('div');
                strategyCard.style.cssText = 'background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;';
                strategyCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${strategy.name}</h4>
                            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">${strategy.type.replace('_', ' ').toUpperCase()} ‚Ä¢ Max Loss: ${strategy.maxLossPercent}%</p>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span class="btn" style="background: ${strategy.status === 'active' ? '#27ae60' : '#95a5a6'}; color: white; padding: 4px 12px; font-size: 12px;">${strategy.status}</span>
                            ${strategy.status === 'active' ? `<button class="btn btn-buy" onclick="placeStrategyOrder(${strategy.id})" style="padding: 4px 12px; font-size: 12px;">Place Order</button>` : ''}
                            <button class="btn btn-sell" onclick="deleteStrategy(${strategy.id})" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                        </div>
                    </div>
                `;
                strategiesList.appendChild(strategyCard);
            });
        }
        
        function placeStrategyOrder(strategyId) {
            if (confirm('Place orders for this strategy in live market?')) {
                fetch(`/api/place-strategy-order/${strategyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadStrategies();
                        // Refresh F&O portfolio to show new positions
                        fetch('/api/fo-portfolio')
                            .then(response => response.json())
                            .then(portfolioData => {
                                displayFOPortfolio(portfolioData);
                            });
                        // Refresh balance
                        fetch('/api/balance')
                            .then(response => response.json())
                            .then(balanceData => {
                                document.getElementById('balance').textContent = balanceData.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            });
                        alert(`‚úÖ ${data.message}`);
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }
        
        function deleteStrategy(strategyId) {
            if (confirm('Are you sure you want to delete this strategy?')) {
                fetch(`/api/delete-strategy/${strategyId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadStrategies();
                        alert('‚úÖ Strategy deleted successfully!');
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }

        // Initialize user profile and theme
        let selectedPaymentMethod = '';
        
        // Set user initial from session username
        if (typeof username !== 'undefined') {
            document.getElementById('userInitial').textContent = username.charAt(0).toUpperCase();
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').checked = true;
        }
        
        // Check if SEBI disclosure was already accepted in this session
        if (sessionStorage.getItem('sebiAccepted') === 'true') {
            document.getElementById('sebiModal').style.display = 'none';
        }
        

        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            
            // Update profile theme toggle
            const profileThemeToggle = document.getElementById('profileThemeToggle');
            if (profileThemeToggle) profileThemeToggle.checked = newTheme === 'dark';
            
            localStorage.setItem('theme', newTheme);
        }
        
        function openUserProfile() {
            // Switch to profile tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate profile tab
            const profileTab = Array.from(document.querySelectorAll('.tab')).find(tab => tab.textContent.trim() === 'Profile');
            if (profileTab) {
                profileTab.classList.add('active');
                document.getElementById('profile').classList.add('active');
                updateProfileData();
            }
        }
        
        function updateProfileData() {
            // Update profile information
            const username = typeof window.username !== 'undefined' ? window.username : 'User';
            document.getElementById('profileUserName').textContent = username;
            document.getElementById('profileInitial').textContent = username.charAt(0).toUpperCase();
            
            // Update balance
            fetch('/api/balance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('profileBalance').textContent = data.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });
            
            // Update active positions count
            fetch('/api/fo-portfolio')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('activePositions').textContent = data.length;
                });
            
            // Sync theme toggle
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.getElementById('profileThemeToggle').checked = isDark;
        }
        
        function showTransactionHistory() {
            alert('üìÑ Transaction History feature coming soon!');
        }
        
        function openAddFunds() {
            document.getElementById('addFundsModal').style.display = 'block';
        }
        
        function openWithdrawFunds() {
            document.getElementById('withdrawFundsModal').style.display = 'block';
            // Update available balance
            fetch('/api/balance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('availableBalance').textContent = data.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });
        }
        
        function closeAddFunds() {
            document.getElementById('addFundsModal').style.display = 'none';
            document.getElementById('fundAmount').value = '';
            selectedPaymentMethod = '';
            // Reset payment option styles
            document.querySelectorAll('.payment-option').forEach(option => {
                option.style.borderColor = 'var(--border-color)';
                option.style.background = 'transparent';
            });
        }
        
        function closeWithdrawFunds() {
            document.getElementById('withdrawFundsModal').style.display = 'none';
            document.getElementById('withdrawAmount').value = '';
        }
        
        function setAmount(amount) {
            const currentAmount = parseFloat(document.getElementById('fundAmount').value) || 0;
            document.getElementById('fundAmount').value = currentAmount + amount;
        }
        
        function setWithdrawAmount(amount) {
            const currentAmount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            document.getElementById('withdrawAmount').value = currentAmount + amount;
        }
        
        function setWithdrawAllAmount() {
            const availableBalance = parseFloat(document.getElementById('availableBalance').textContent.replace(/,/g, ''));
            document.getElementById('withdrawAmount').value = availableBalance;
        }
        
        function selectPayment(method) {
            selectedPaymentMethod = method;
            // Reset all payment options
            document.querySelectorAll('.payment-option').forEach(option => {
                option.style.borderColor = 'var(--border-color)';
                option.style.background = 'transparent';
            });
            // Highlight selected option
            event.currentTarget.style.borderColor = '#3498db';
            event.currentTarget.style.background = 'rgba(52, 152, 219, 0.1)';
        }
        
        function processFundAddition() {
            const amount = parseFloat(document.getElementById('fundAmount').value);
            
            if (!amount || amount < 100) {
                alert('‚ö†Ô∏è Please enter a valid amount (minimum ‚Çπ100)');
                return;
            }
            
            if (!selectedPaymentMethod) {
                alert('‚ö†Ô∏è Please select a payment method');
                return;
            }
            
            // Simulate payment processing
            const paymentMethods = {
                'upi': 'UPI Payment',
                'phonepe': 'PhonePe',
                'gpay': 'Google Pay',
                'netbanking': 'Net Banking'
            };
            
            if (confirm(`Proceed with ${paymentMethods[selectedPaymentMethod]} payment of ‚Çπ${amount.toLocaleString('en-IN')}?`)) {
                // Call API to add funds
                fetch('/api/add-funds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        paymentMethod: selectedPaymentMethod
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeAddFunds();
                        // Refresh balance
                        fetch('/api/balance')
                            .then(response => response.json())
                            .then(balanceData => {
                                document.getElementById('balance').textContent = balanceData.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            });
                        alert(`‚úÖ ‚Çπ${amount.toLocaleString('en-IN')} added successfully to your wallet!`);
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }
        

        
        function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            
            if (!amount || amount < 100) {
                alert('‚ö†Ô∏è Please enter a valid amount (minimum ‚Çπ100)');
                return;
            }
            
            if (confirm(`Withdraw ‚Çπ${amount.toLocaleString('en-IN')} from your wallet?\n\nFunds will be credited to your registered bank account within 2-3 business days.`)) {
                // Call API to withdraw funds
                fetch('/api/withdraw-funds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeWithdrawFunds();
                        // Refresh balance
                        fetch('/api/balance')
                            .then(response => response.json())
                            .then(balanceData => {
                                document.getElementById('balance').textContent = balanceData.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            });
                        alert(`‚úÖ ${data.message}`);
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                });
            }
        }

        loadData();
        
        // Only refresh balance and portfolio data, not options chain
        setInterval(() => {
            fetch('/api/balance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('balance').textContent = data.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });

            fetch('/api/fo-portfolio')
                .then(response => response.json())
                .then(data => {
                    displayFOPortfolio(data);
                });

            fetch('/api/nifty-price')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('niftyPrice').textContent = data.price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });
        }, 10000); // Reduced frequency to 10 seconds
    </script>
</body>
</html>